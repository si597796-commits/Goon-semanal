<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goon Semanal - DEBUG</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:system-ui,serif;background:#fcfcf9;color:#134252;padding:20px;min-height:100vh}.container{max-width:1200px;margin:0 auto}header{text-align:center;margin-bottom:30px}h1{font-size:28px;margin-bottom:8px}.status{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;background:rgba(33,128,141,.1);border:1px solid rgba(33,128,141,.25);border-radius:6px;font-size:13px;color:#208091;font-weight:500}.status.connected::before{content:'';width:8px;height:8px;background:#208091;border-radius:50%;animation:pulse 2s infinite}@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}.setup-section,.device{background:#fffffe;border:1px solid rgba(94,82,64,.2);border-radius:12px;padding:30px;margin-bottom:30px}.setup-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px}.form-group{margin-bottom:15px}label{display:block;font-size:12px;font-weight:600;color:#627c7d;margin-bottom:6px;text-transform:uppercase}input{width:100%;padding:10px 12px;border:1px solid rgba(94,82,64,.2);border-radius:8px;font-size:14px;background:#fffffe;transition:border-color .25s}input:focus{outline:none;border-color:#208091;box-shadow:0 0 0 3px rgba(33,128,141,.4)}button{padding:12px 20px;border:none;border-radius:8px;font-size:14px;font-weight:500;cursor:pointer;transition:all .25s;font-family:inherit}.btn-primary{background:#208091;color:#fcfcf9;width:100%;margin-top:15px}.btn-primary:hover{background:#1d7480}.btn-primary.loading{background:#627c7d;cursor:not-allowed}.btn-increment{background:#208091;color:#fff;border-radius:50%;width:70px;height:70px;font-size:24px;font-weight:700;margin:15px auto}.btn-increment:hover{background:#1d7480;transform:scale(1.05)}button:active{transform:scale(.98)}.devices-grid{display:grid;grid-template-columns:1fr 1fr;gap:30px}.device{text-align:center;box-shadow:0 1px 3px rgba(0,0,0,.04)}.device-label{font-size:12px;font-weight:600;color:#627c7d;text-transform:uppercase;letter-spacing:.05em;margin-bottom:20px}.counter-display{font-size:64px;font-weight:800;font-family:monospace;margin:20px 0;min-height:80px;display:flex;align-items:center;justify-content:center}.device1 .counter-display{color:#ff6b6b}.device2 .counter-display{color:#4ecdc4}.total-display{background:linear-gradient(135deg,#ff6b6b,#4ecdc4);color:#fff;border-radius:12px;padding:25px;text-align:center;grid-column:1/-1;margin-top:20px}.total-display h3{font-size:14px;margin-bottom:10px;text-transform:uppercase;opacity:.9}.total-number{font-size:48px;font-weight:800;font-family:monospace}.reset-info,.debug{background:rgba(33,128,141,.08);border:1px solid rgba(33,128,141,.2);border-radius:8px;padding:12px;font-size:12px;color:#627c7d;margin-top:15px}.debug{animation:flash 1s infinite}@keyframes flash{50%{background:#ffeb3b}}#debugLog{max-height:200px;overflow:auto;background:#f5f5f5;padding:10px;border-radius:8px;font-family:monospace;font-size:11px;margin-top:10px}@media(max-width:768px){.devices-grid,.setup-grid{grid-template-columns:1fr}h1{font-size:24px}.counter-display{font-size:48px}}
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéØ Goon Semanal - DEBUG</h1>
            <div class="status" id="status">‚óè Carregando...</div>
        </header>

        <div class="setup-section" id="setupSection">
            <h2>‚öôÔ∏è Firebase <span id="savedStatus"></span></h2>
            <div class="setup-grid">
                <div class="form-group">
                    <label>API Key</label>
                    <input id="apiKey" placeholder="AIza...">
                </div>
                <div class="form-group">
                    <label>Database URL</label>
                    <input id="databaseURL" placeholder="https://projeto-default-rtdb.firebaseio.com/">
                </div>
                <div class="form-group">
                    <label>Project ID</label>
                    <input id="projectId" placeholder="projeto">
                </div>
                <div class="form-group">
                    <label>Auth Domain</label>
                    <input id="authDomain" placeholder="projeto.firebaseapp.com">
                </div>
            </div>
            <div class="info-box">Firebase Console ‚Üí ‚öôÔ∏è ‚Üí Chaves da Web</div>
            <button class="btn-primary" onclick="connectFirebase()" id="connectBtn">üîó Conectar & Salvar</button>
            <button class="btn-primary" onclick="clearSaved()" id="clearBtn" style="margin-top:10px; background:#ff6b6b;">üóëÔ∏è Limpar Dados</button>
            <div class="debug" id="debugMsg">Clique conectar para ver logs...</div>
            <div id="debugLog"></div>
        </div>

        <div class="devices-grid" id="devicesGrid" style="display:none;">
            <div class="device device1">
                <div class="device-label">üë¶ Bobinho</div>
                <div class="counter-display" id="counter1">0</div>
                <button class="btn-increment" onclick="incrementCounter(1)">+</button>
                <div class="reset-info" id="resetInfo1">Reset: 7 dias</div>
            </div>
            <div class="device device2">
                <div class="device-label">üëß Bobinha</div>
                <div class="counter-display" id="counter2">0</div>
                <button class="btn-increment" onclick="incrementCounter(2)">+</button>
                <div class="reset-info" id="resetInfo2">Reset: 7 dias</div>
            </div>
            <div class="total-display">
                <h3>Total Semanal</h3>
                <div class="total-number" id="totalCounter">0</div>
            </div>
        </div>
    </div>

    <script>
        let db, isConnected=false, counters={bobinho:0,bobinha:0};
        const log = msg => {
            console.log(msg);
            const logDiv = document.getElementById('debugLog');
            logDiv.innerHTML += new Date().toLocaleTimeString() + ': ' + msg + '<br>';
            logDiv.scrollTop = logDiv.scrollHeight;
            document.getElementById('debugMsg').textContent = msg;
        };
        
        window.onload = function() {
            log('üîÑ Carregando dados salvos...');
            const saved = localStorage.getItem('goonFirebase');
            if(saved) {
                try {
                    const config = JSON.parse(saved);
                    document.getElementById('apiKey').value = config.apiKey || '';
                    document.getElementById('databaseURL').value = config.databaseURL || '';
                    document.getElementById('projectId').value = config.projectId || '';
                    document.getElementById('authDomain').value = config.authDomain || '';
                    document.getElementById('savedStatus').textContent = '(‚úÖ SALVO)';
                    document.getElementById('connectBtn').textContent = 'üöÄ Conectar Agora';
                    log('‚úÖ Dados carregados do localStorage');
                } catch(e) {
                    log('‚ùå Erro ao carregar dados salvos: ' + e.message);
                }
            } else {
                log('‚ÑπÔ∏è Sem dados salvos - insira credenciais');
            }
        }
        
        function connectFirebase(){
            const btn=document.getElementById('connectBtn'), status=document.getElementById('status');
            const config={
                apiKey:document.getElementById('apiKey').value.trim(),
                databaseURL:document.getElementById('databaseURL').value.trim(),
                projectId:document.getElementById('projectId').value.trim(),
                authDomain:document.getElementById('authDomain').value.trim()
            };
            
            log('üîÑ Tentando conectar com: ' + config.databaseURL);
            
            if(!config.apiKey||!config.databaseURL){
                log('‚ùå API Key ou Database URL vazios');
                alert('API Key + Database URL obrigat√≥rios!');
                return;
            }
            
            localStorage.setItem('goonFirebase', JSON.stringify(config));
            document.getElementById('savedStatus').textContent = '(‚úÖ SALVO)';
            
            btn.textContent='üîÑ Conectando...'; btn.classList.add('loading');
            
            try{
                log('‚úÖ Firebase inicializando...');
                firebase.initializeApp(config);
                db=firebase.database();
                log('‚úÖ Database criada');
                
                db.ref('.info/connected').on('value',snap=>{
                    log('üîå Status conex√£o: ' + snap.val());
                    if(snap.val()){
                        isConnected=true;
                        status.className='status connected';
                        status.textContent='‚óè Conectado ‚úÖ';
                        document.getElementById('setupSection').style.display='none';
                        document.getElementById('devicesGrid').style.display='grid';
                        checkReset(); 
                        startListen();
                        btn.textContent='‚úÖ Funcionando!'; 
                        btn.disabled=true;
                        log('üéâ CONECTADO E PRONTO!');
                    }else{
                        status.textContent='‚óè Desconectado';
                        log('‚ùå Desconectado do Firebase');
                    }
                });
            }catch(e){
                log('üí• ERRO Firebase: ' + e.message);
                alert('Erro: ' + e.message);
                btn.textContent='üîó Conectar'; btn.classList.remove('loading');
            }
        }
        
        function checkReset(){
            log('üîÑ Verificando reset semanal...');
            db.ref('meta/lastReset').once('value',snap=>{
                log('Meta lida: ' + snap.val());
                const now=new Date(), meta=snap.val();
                if(!meta||(now-new Date(meta))/(86400000)>=7){
                    log('üîÑ Fazendo reset semanal...');
                    db.ref('counters').set({bobinho:0,bobinha:0,total:0});
                    db.ref('meta').set({lastReset:now.toISOString()});
                    showResetMsg();
                } else {
                    log('‚úÖ Sem reset necess√°rio');
                }
            });
        }
        
        function startListen(){
            log('üëÇ Iniciando listener dos contadores...');
            db.ref('counters').on('value',snap=>{
                const data=snap.val()||{bobinho:0,bobinha:0,total:0};
                log('üìä Dados recebidos: bobinho=' + data.bobinho + ', bobinha=' + data.bobinha + ', total=' + data.total);
                counters=data;
                document.getElementById('counter1').textContent=data.bobinho||0;
                document.getElementById('counter2').textContent=data.bobinha||0;
                document.getElementById('totalCounter').textContent=data.total||0;
            });
        }
        
        function incrementCounter(device){
            log('‚ûï Clique no dispositivo ' + device);
            if(!isConnected){ 
                log('‚ùå N√£o conectado!');
                alert('Conecte primeiro!');
                return;
            }
            
            log('üìñ Lendo valores atuais...');
            db.ref('counters').once('value', snap => {
                const data = snap.val() || {bobinho:0, bobinha:0, total:0};
                log('üìñ Valores atuais: ' + JSON.stringify(data));
                
                let newBobinho = data.bobinho || 0;
                let newBobinha = data.bobinha || 0;
                
                if(device === 1) {
                    newBobinho += 1;
                    log('üë¶ Bobinho: ' + (data.bobinho||0) + ' ‚Üí ' + newBobinho);
                } else {
                    newBobinha += 1;
                    log('üëß Bobinha: ' + (data.bobinha||0) + ' ‚Üí ' + newBobinha);
                }
                
                const newTotal = newBobinho + newBobinha;
                log('üíæ Salvando: bobinho=' + newBobinho + ', bobinha=' + newBobinha + ', total=' + newTotal);
                
                db.ref('counters').set({
                    bobinho: newBobinho,
                    bobinha: newBobinha,
                    total: newTotal
                }).then(() => {
                    log('‚úÖ SALVO NO FIREBASE!');
                }).catch(e => {
                    log('üí• ERRO ao salvar: ' + e.message);
                });
            });
        }
        
        function clearSaved(){
            localStorage.removeItem('goonFirebase');
            location.reload();
        }
        
        function showResetMsg(){
            document.getElementById('resetInfo1').textContent='‚úÖ RESET HOJE!';
            document.getElementById('resetInfo2').textContent='‚úÖ RESET HOJE!';
            setTimeout(()=> {
                document.getElementById('resetInfo1').textContent='Reset: 7 dias';
                document.getElementById('resetInfo2').textContent='Reset: 7 dias';
            },3000);
        }
        
        window.connectFirebase=connectFirebase;
        window.incrementCounter=incrementCounter;
        window.clearSaved=clearSaved;
    </script>
</body>
</html>
